import React, { useState, useEffect } from 'react';
import { useData } from '../../hooks/useData';
import { useDataContext } from '../../context/DataContext';

function Recommendations() {
  const [recommendations, setRecommendations] = useState([]);
  const { loading, error, handleRequest, mlAPI } = useData();
  const { dataLoaded } = useDataContext();

  useEffect(() => {
    if (dataLoaded) {
      loadRecommendations();
    }
  }, [dataLoaded]);

  const loadRecommendations = async () => {
    try {
      const result = await handleRequest(() => mlAPI.getRecommendations());
      setRecommendations(result);
    } catch (err) {
      console.error('Failed to load recommendations:', err);
    }
  };

  if (!dataLoaded) {
    return (
      <div className="card">
        <h2>ðŸŽ¯ ML Recommendations</h2>
        <div className="alert alert-info">
          Load data first to generate recommendations
        </div>
      </div>
    );
  }

  if (loading) {
    return (
      <div className="card">
        <h2>ðŸŽ¯ ML Recommendations</h2>
        <div className="loading">
          <div className="spinner"></div>
          <p style={{ marginTop: '1rem', color: '#64748b' }}>
            Generating recommendations...
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="card">
      <h2>ðŸŽ¯ ML Recommendations</h2>
      <p style={{ color: '#64748b', marginBottom: '1.5rem' }}>
        Data-driven business recommendations powered by machine learning
      </p>

      {error && (
        <div className="alert alert-error">{error}</div>
      )}

      {recommendations.length === 0 ? (
        <div className="alert alert-warning">
          No recommendations available. Try loading more data.
        </div>
      ) : (
        <div className="grid-2">
          {recommendations.map((rec, idx) => (
            <div
              key={idx}
              style={{
                padding: '1.5rem',
                background: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)',
                borderRadius: '12px',
                border: '2px solid #cbd5e1',
              }}
            >
              <div style={{ fontSize: '2.5rem', marginBottom: '1rem' }}>
                {rec.icon}
              </div>
              <h3 style={{ marginBottom: '0.8rem', color: '#1e293b' }}>
                {rec.title}
              </h3>
              <p style={{ color: '#475569', lineHeight: '1.6', marginBottom: '1rem' }}>
                {rec.detail}
              </p>
              <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                <span style={{ fontSize: '0.85rem', color: '#64748b', fontWeight: '500' }}>
                  Confidence:
                </span>
                <div
                  style={{
                    flex: 1,
                    height: '6px',
                    background: '#e2e8f0',
                    borderRadius: '3px',
                    overflow: 'hidden',
                  }}
                >
                  <div
                    style={{
                      width: `${rec.confidence}%`,
                      height: '100%',
                      background: rec.confidence > 85
                        ? '#10b981'
                        : rec.confidence > 70
                        ? '#667eea'
                        : '#f59e0b',
                      borderRadius: '3px',
                    }}
                  ></div>
                </div>
                <span style={{ fontSize: '0.85rem', fontWeight: '700', color: '#475569' }}>
                  {rec.confidence}%
                </span>
              </div>
            </div>
          ))}
        </div>
      )}

      <div className="alert alert-success" style={{ marginTop: '1.5rem' }}>
        <strong>âœ¨ Pro Tip:</strong> These recommendations are generated by analyzing patterns 
        in your data including revenue trends, customer segments, product performance, and data quality. 
        Prioritize actions with higher confidence scores.
      </div>
    </div>
  );
}

export default Recommendations;